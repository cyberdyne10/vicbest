const NGN = new Intl.NumberFormat('en-NG', { style: 'currency', currency: 'NGN', maximumFractionDigits: 0 });
const ADMIN_TOKEN_KEY = 'vicbest_admin_token'; const ORDER_STATUSES = ['pending_payment', 'paid', 'processing', 'delivered', 'cancelled'];
let token = localStorage.getItem(ADMIN_TOKEN_KEY) || ''; let products = [];
const $ = (id) => document.getElementById(id);
const authHeaders = () => ({ 'Content-Type': 'application/json', Authorization: `Bearer ${token}` });

function setAuthState(ok) { $('login-card').classList.toggle('hidden', ok); $('dashboard').classList.toggle('hidden', !ok); $('logout-btn').classList.toggle('hidden', !ok); }
async function login(password) { const r = await fetch('/api/admin/login', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ password }) }); const d = await r.json(); if (!r.ok) throw new Error(d.error || 'Login failed'); token = d.token; localStorage.setItem(ADMIN_TOKEN_KEY, token); }

async function fetchMetrics() { const r = await fetch('/api/admin/dashboard/metrics', { headers: authHeaders() }); const d = await r.json(); if (!r.ok) return; const m = d.data; $('metrics-grid').innerHTML = [{k:'Orders',v:m.totalOrders},{k:'Paid',v:m.paidOrders},{k:'Revenue',v:NGN.format(m.revenue)},{k:'Products',v:m.products},{k:'Users',v:m.users}].map((x)=>`<div class="bg-white border rounded-xl p-3"><p class="text-xs text-gray-500">${x.k}</p><p class="text-lg font-bold">${x.v}</p></div>`).join(''); }
async function fetchLowStock() { const r = await fetch('/api/admin/products/low-stock', { headers: authHeaders() }); const d = await r.json(); if (!r.ok) return; $('low-stock').textContent = d.data?.length ? `Low stock: ${d.data.map((x) => `${x.name} (${x.stock_quantity})`).join(', ')}` : 'No low-stock alerts'; }

function fillForm(p){ $('product-id').value=p.id; $('product-name').value=p.name; $('product-category').value=p.category; $('product-price').value=p.price; $('product-stock-qty').value=p.stock_quantity ?? 0; $('product-image').value=p.image_url||''; $('product-description').value=p.description||''; $('product-metadata').value=JSON.stringify(p.metadata||{},null,2); $('product-stock').checked=Boolean(p.in_stock); }
function resetForm(){ ['product-id','product-name','product-price','product-image','product-description'].forEach((k)=>$(k).value=''); $('product-category').value='car'; $('product-stock-qty').value='10'; $('product-metadata').value='{}'; $('product-stock').checked=true; $('product-form-msg').textContent=''; }

async function fetchProducts(){ const r=await fetch('/api/admin/products',{headers:authHeaders()}); const d=await r.json(); if(!r.ok) throw new Error(d.error||'Failed products'); products=d.data||[]; $('products-tbody').innerHTML=products.map((p)=>`<tr class="border-b"><td>${p.id}</td><td>${p.name}</td><td>${p.category}</td><td>${NGN.format(p.price)}</td><td>${p.stock_quantity ?? '-'}</td><td>${p.in_stock?'In':'Out'}</td><td><button data-edit="${p.id}" class="text-blue-700">Edit</button> <button data-del="${p.id}" class="text-red-700">Delete</button></td></tr>`).join(''); document.querySelectorAll('[data-edit]').forEach((b)=>b.onclick=()=>fillForm(products.find((x)=>x.id===Number(b.dataset.edit)))); document.querySelectorAll('[data-del]').forEach((b)=>b.onclick=async()=>{ if(!confirm('Delete this product?'))return; const r=await fetch(`/api/admin/products/${b.dataset.del}`,{method:'DELETE',headers:authHeaders()}); if(r.ok){fetchProducts(); fetchMetrics();} }); }
function orderCard(o){ const opts=ORDER_STATUSES.map((s)=>`<option value="${s}" ${o.status===s?'selected':''}>${s}</option>`).join(''); const items=(o.items||[]).map((i)=>`<li>${i.quantity} × ${i.product_name}</li>`).join(''); return `<div class="border rounded-xl p-4"><div class="flex justify-between"><div><p class="font-bold">Order #${o.id} • ${o.payment_reference||'N/A'}</p><p class="text-sm">${o.customer_name} • ${o.customer_email}</p></div><div><p class="font-semibold">${NGN.format(o.amount)}</p><select data-order-status="${o.id}" class="border rounded">${opts}</select></div></div><ul class="text-sm mt-2 list-disc pl-5">${items||'<li>No items</li>'}</ul></div>`; }
async function fetchOrders(){ const f=$('order-filter').value; const r=await fetch(`/api/admin/orders${f?`?status=${encodeURIComponent(f)}`:''}`,{headers:authHeaders()}); const d=await r.json(); if(!r.ok) throw new Error(d.error||'Orders failed'); $('orders-wrap').innerHTML=(d.data||[]).map(orderCard).join('')||'<p class="text-gray-500">No orders yet.</p>'; document.querySelectorAll('[data-order-status]').forEach((s)=>s.onchange=async()=>{ await fetch(`/api/admin/orders/${s.dataset.orderStatus}/status`,{method:'PATCH',headers:authHeaders(),body:JSON.stringify({status:s.value})}); fetchMetrics(); }); }

async function bootstrap(){ setAuthState(true); await Promise.all([fetchMetrics(),fetchLowStock(),fetchProducts(),fetchOrders()]); $('export-csv').onclick=(e)=>{ e.preventDefault(); window.open(`/api/admin/orders/export.csv?token=${encodeURIComponent(token)}`,'_blank'); } }
$('login-form').onsubmit=async(e)=>{ e.preventDefault(); try{ await login($('admin-password').value); await bootstrap(); }catch(err){ $('login-error').classList.remove('hidden'); $('login-error').textContent=err.message; } };
$('product-form').onsubmit=async(e)=>{ e.preventDefault(); try{ const id=$('product-id').value; const payload={name:$('product-name').value,category:$('product-category').value,price:Number($('product-price').value),stock_quantity:Number($('product-stock-qty').value),image_url:$('product-image').value,description:$('product-description').value,metadata:$('product-metadata').value,in_stock:$('product-stock').checked}; const r=await fetch(id?`/api/admin/products/${id}`:'/api/admin/products',{method:id?'PUT':'POST',headers:authHeaders(),body:JSON.stringify(payload)}); const d=await r.json(); if(!r.ok) throw new Error(d.error||'Save failed'); $('product-form-msg').textContent='Saved.'; resetForm(); await Promise.all([fetchProducts(),fetchLowStock(),fetchMetrics()]); }catch(err){ $('product-form-msg').textContent=err.message; } };
$('reset-product').onclick=resetForm; $('order-filter').onchange=fetchOrders; $('logout-btn').onclick=()=>{ token=''; localStorage.removeItem(ADMIN_TOKEN_KEY); setAuthState(false); };
if(token) bootstrap(); else setAuthState(false);